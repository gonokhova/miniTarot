const TelegramBot = require('node-telegram-bot-api');
const express = require('express');

const token = '7876942204:AAHjs9Px4CkRoqjPrIwPy1KAOZmJPg-iCVk';
const bot = new TelegramBot(token, { polling: true });

// База данных (пока в памяти)
let users = {};
let subscriptions = {};

// === ПОЛНАЯ КОЛОДА ТАРО (78 карт) ===
const tarotCards = [
  // Старшие Арканы (22 карты)
  { name: "0. Шут", meaning: "Невинность, новые начинания, спонтанность, свобода" },
  { name: "I. Маг", meaning: "Сила воли, мастерство, концентрация, инициатива" },
  { name: "II. Верховная Жрица", meaning: "Тайны, интуиция, скрытое знание, мудрость" },
  { name: "III. Императрица", meaning: "Изобилие, плодородие, творчество, материнство" },
  { name: "IV. Император", meaning: "Власть, структура, порядок, стабильность" },
  { name: "V. Иерофант", meaning: "Традиция, религия, духовность, наставничество" },
  { name: "VI. Влюблённые", meaning: "Любовь, выбор, гармония, отношения" },
  { name: "VII. Колесница", meaning: "Победа, контроль, движение, решимость" },
  { name: "VIII. Сила", meaning: "Смелость, терпение, внутренняя сила, сострадание" },
  { name: "IX. Отшельник", meaning: "Самоанализ, одиночество, поиск истины" },
  { name: "X. Колесо Фортуны", meaning: "Судьба, удача, циклы, неожиданные перемены" },
  { name: "XI. Справедливость", meaning: "Баланс, карма, честность, закон" },
  { name: "XII. Повешенный", meaning: "Жертва, смена перспективы, пауза" },
  { name: "XIII. Смерть", meaning: "Конец цикла, трансформация, перерождение" },
  { name: "XIV. Умеренность", meaning: "Гармония, баланс, терпение, исцеление" },
  { name: "XV. Дьявол", meaning: "Иллюзии, зависимости, материальные искушения" },
  { name: "XVI. Башня", meaning: "Крах иллюзий, неожиданные перемены, откровение" },
  { name: "XVII. Звезда", meaning: "Надежда, вдохновение, духовное руководство" },
  { name: "XVIII. Луна", meaning: "Страхи, иллюзии, подсознание, неопределённость" },
  { name: "XIX. Солнце", meaning: "Радость, успех, ясность, жизненная сила" },
  { name: "XX. Суд", meaning: "Возрождение, призыв к действию, подведение итогов" },
  { name: "XXI. Мир", meaning: "Завершение, гармония, путешествия, успех" },

  // Младшие Арканы: Жезлы (14 карт)
  { name: "Туз Жезлов", meaning: "Энергия, новые начинания, творческий потенциал" },
  { name: "Двойка Жезлов", meaning: "Планирование, сотрудничество, будущие возможности" },
  { name: "Тройка Жезлов", meaning: "Предпринимательство, экспансия, дальновидность" },
  { name: "Четвёрка Жезлов", meaning: "Праздник, стабильность, домашний уют" },
  { name: "Пятёрка Жезлов", meaning: "Конфликт, соперничество, борьба за идеи" },
  { name: "Шестёрка Жезлов", meaning: "Победа, признание, успех" },
  { name: "Семёрка Жезлов", meaning: "Защита своих убеждений, стойкость" },
  { name: "Восьмёрка Жезлов", meaning: "Быстрое движение, новости, поездки" },
  { name: "Девятка Жезлов", meaning: "Устойчивость, бдительность, последний рубеж" },
  { name: "Десятка Жезлов", meaning: "Бремя, ответственность, перегрузка" },
  { name: "Паж Жезлов", meaning: "Энтузиазм, новые идеи, вдохновение" },
  { name: "Рыцарь Жезлов", meaning: "Страсть, действие, авантюризм" },
  { name: "Королева Жезлов", meaning: "Уверенность, харизма, лидерство" },
  { name: "Король Жезлов", meaning: "Сила воли, решительность, авторитет" },

  // Младшие Арканы: Кубки (14 карт)
  { name: "Туз Кубков", meaning: "Новые чувства, любовь, эмоциональное пробуждение" },
  { name: "Двойка Кубков", meaning: "Союз, гармония, взаимные чувства" },
  { name: "Тройка Кубков", meaning: "Дружба, празднование, радость" },
  { name: "Четвёрка Кубков", meaning: "Апатия, упущенные возможности, самоанализ" },
  { name: "Пятёрка Кубков", meaning: "Потеря, сожаление, фокус на негативе" },
  { name: "Шестёрка Кубков", meaning: "Ностальгия, детские воспоминания, невинность" },
  { name: "Семёрка Кубков", meaning: "Иллюзии, выбор, мечты" },
  { name: "Восьмёрка Кубков", meaning: "Уход, поиск нового, разочарование" },
  { name: "Девятка Кубков", meaning: "Удовлетворение, исполнение желаний" },
  { name: "Десятка Кубков", meaning: "Гармония в семье, счастье, домашний уют" },
  { name: "Паж Кубков", meaning: "Чувствительность, новые эмоции, романтика" },
  { name: "Рыцарь Кубков", meaning: "Идеализм, романтика, эмоциональное предложение" },
  { name: "Королева Кубков", meaning: "Забота, интуиция, эмоциональная зрелость" },
  { name: "Король Кубков", meaning: "Мудрость, эмоциональный контроль, сострадание" },

  // Младшие Арканы: Мечи (14 карт)
  { name: "Туз Мечей", meaning: "Ясность мысли, прорыв, интеллектуальная победа" },
  { name: "Двойка Мечей", meaning: "Тупик, сложный выбор, избегание правды" },
  { name: "Тройка Мечей", meaning: "Сердечная боль, предательство, разочарование" },
  { name: "Четвёрка Мечей", meaning: "Отдых, восстановление, медитация" },
  { name: "Пятёрка Мечей", meaning: "Конфликт, победа любой ценой, унижение" },
  { name: "Шестёрка Мечей", meaning: "Переход, движение к спокойствию" },
  { name: "Семёрка Мечей", meaning: "Обман, хитрость, скрытые мотивы" },
  { name: "Восьмёрка Мечей", meaning: "Ограничения, жертва, чувство ловушки" },
  { name: "Девятка Мечей", meaning: "Тревога, кошмары, чувство вины" },
  { name: "Десятка Мечей", meaning: "Конец, болезненное завершение" },
  { name: "Паж Мечей", meaning: "Любопытство, новые идеи, бдительность" },
  { name: "Рыцарь Мечей", meaning: "Решительность, агрессия, напор" },
  { name: "Королева Мечей", meaning: "Независимость, ясность, справедливость" },
  { name: "Король Мечей", meaning: "Интеллект, власть, рациональность" },

  // Младшие Арканы: Пентакли (14 карт)
  { name: "Туз Пентаклей", meaning: "Материальное благополучие, новые возможности" },
  { name: "Двойка Пентаклей", meaning: "Баланс, адаптация, гибкость" },
  { name: "Тройка Пентаклей", meaning: "Сотрудничество, мастерство, рост" },
  { name: "Четвёрка Пентаклей", meaning: "Сохранение, контроль, жадность" },
  { name: "Пятёрка Пентаклей", meaning: "Финансовые трудности, изоляция" },
  { name: "Шестёрка Пентаклей", meaning: "Щедрость, помощь, обмен" },
  { name: "Семёрка Пентаклей", meaning: "Терпение, долгосрочные инвестиции" },
  { name: "Восьмёрка Пентаклей", meaning: "Усердие, мастерство, внимание к деталям" },
  { name: "Девятка Пентаклей", meaning: "Удовольствие, достаток, самодостаточность" },
  { name: "Десятка Пентаклей", meaning: "Богатство, семейное благополучие, наследие" },
  { name: "Паж Пентаклей", meaning: "Обучение, новые навыки, потенциал" },
  { name: "Рыцарь Пентаклей", meaning: "Надёжность, трудолюбие, медленный прогресс" },
  { name: "Королева Пентаклей", meaning: "Практичность, забота, изобилие" },
  { name: "Король Пентаклей", meaning: "Богатство, стабильность, безопасность" }
];

// === ФУНКЦИИ БОТА ===
bot.onText(/\/start/, (msg) => {
  const chatId = msg.chat.id;
  const warning = "⚠️ Внимание! Это приложение исключительно для развлечения. Таро не гарантирует точных предсказаний.";
  const menu = "Выбери расклад:\n1. Карта дня (/card)\n2. Расклад на неделю (/week)\n3. Ответ Да/Нет (/yesno)";
  bot.sendMessage(chatId, warning + "\n\n" + menu);
});

// Карта дня
bot.onText(/\/card/, (msg) => {
  const chatId = msg.chat.id;
  const userId = msg.from.id;

  if (users[userId] && users[userId].freeUses >= 2 && !subscriptions[userId]) {
    bot.sendMessage(chatId, "❌ Лимит бесплатных раскладов исчерпан. Купи подписку /subscribe.");
    return;
  }

  const randomCard = tarotCards[Math.floor(Math.random() * tarotCards.length)];
  const response = `🔮 Твоя карта дня: *${randomCard.name}*\n\n*Толкование*: ${randomCard.meaning}`;

  if (!users[userId]) {
    users[userId] = { freeUses: 0, history: [] };
  }
  users[userId].freeUses += 1;
  users[userId].history.push(`Карта дня: ${randomCard.name}`);

  bot.sendMessage(chatId, response, { parse_mode: "Markdown" });
});

// Подписка (имитация)
bot.onText(/\/subscribe/, (msg) => {
  const chatId = msg.chat.id;
  const userId = msg.from.id;
  
  subscriptions[userId] = new Date().getTime() + 30 * 24 * 60 * 60 * 1000; // +30 дней
  bot.sendMessage(chatId, "✅ Ты оформил подписку на месяц! Теперь расклады без ограничений.");
});

// История
bot.onText(/\/history/, (msg) => {
  const chatId = msg.chat.id;
  const userId = msg.from.id;
  
  if (users[userId] && users[userId].history.length > 0) {
    const historyText = "📜 Твоя история раскладов:\n" + users[userId].history.join("\n");
    bot.sendMessage(chatId, historyText);
  } else {
    bot.sendMessage(chatId, "У тебя еще нет истории раскладов.");
  }
});

// Запуск сервера
const app = express();
const PORT = 3000;
app.listen(PORT, () => {
  console.log(`Бот запущен!`);
});
